# Caddyfile for CV-Gen
# Architecture: Pure Caddy (no Nginx)
# - Automatic HTTPS via Let's Encrypt
# - Static file serving from /srv (frontend build)
# - Reverse proxy for /api/* to backend
#
# ⚠️  IMPORTANT: Ensure DNS is configured before starting
#    Run: make prod-up or make staging-up

# =============================================================================
# Global Options
# =============================================================================
{
    # Email for Let's Encrypt
    email admin@cv.aidityas.me

    # Runtime configuration
    admin off

    # Logging
    log {
        level INFO
        format json
        output stdout
    }
}

# =============================================================================
# Production Environment
# =============================================================================
cv.aidityas.me {
    # Redirect www to non-www
    @www {
        host www.cv.aidityas.me
    }
    handle @www {
        redir https://cv.aidityas.me
    }

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
        -X-Powered-By
    }

    # Handle API requests FIRST
    @api path /api/*
    handle @api {
        reverse_proxy backend:8080 {
            transport http {
                read_buffer 8192
            }
        }
    }

    # Handle everything else (static files)
    handle {
        root * /srv
        try_files {path} /index.html
        file_server {
            precompressed gzip
        }
    }

    # Enable compression
    encode gzip zstd
}

# =============================================================================
# Staging Environment
# =============================================================================
cvstaging.aidityas.me {
    # Handle API requests FIRST
    @api path /api/*
    handle @api {
        reverse_proxy backend:8080 {
            transport http {
                read_buffer 8192
            }
        }
    }

    # Handle everything else (static files)
    handle {
        root * /srv
        try_files {path} /index.html
        file_server {
            precompressed gzip
        }
    }

    # Enable compression
    encode gzip zstd
}
